services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: tplexity-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - tplexity-network

  retriever:
    build:
      context: .
      dockerfile: src/tplexity/retriever/Dockerfile
    image: tplexity-retriever:latest
    pull_policy: build
    container_name: tplexity-retriever
    ports:
      - "8010:8010"
    env_file:
      - src/tplexity/retriever/.env
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    depends_on:
      - qdrant
    networks:
      - tplexity-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  redis:
    image: redis:7-alpine
    container_name: tplexity-redis-memory
    ports:
      - "6389:6379"
    volumes:
      - redis_data:/data
    networks:
      - tplexity-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    command: redis-server --appendonly yes

  llm_client:
    build:
      context: .
      dockerfile: src/tplexity/llm_client/Dockerfile
    image: tplexity-llm-client:latest
    pull_policy: build
    container_name: tplexity-llm-client
    ports:
      - "8014:8014"
    env_file:
      - src/tplexity/llm_client/.env
    networks:
      - tplexity-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8014/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  generation:
    build:
      context: .
      dockerfile: src/tplexity/generation/Dockerfile
    image: tplexity-generation:latest
    pull_policy: build
    container_name: tplexity-generation
    ports:
      - "8012:8012"
    env_file:
      - src/tplexity/generation/.env
    environment:
      - RETRIEVER_API_URL=http://retriever:8010
      - LLM_CLIENT_API_URL=http://llm_client:8014
      - REDIS_HOST=redis
    depends_on:
      retriever:
        condition: service_healthy
      llm_client:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tplexity-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  bot:
    build:
      context: .
      dockerfile: src/tplexity/bot/Dockerfile
    image: tplexity-bot:latest
    pull_policy: build
    container_name: tplexity-bot
    ports:
      - "8013:8013"
    env_file:
      - src/tplexity/bot/.env
    environment:
      - GENERATION_API_URL=http://generation:8012
    depends_on:
      generation:
        condition: service_healthy
    networks:
      - tplexity-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8013/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  parser:
    build:
      context: .
      dockerfile: src/tplexity/parser/Dockerfile
    image: tplexity-parser:latest
    pull_policy: build
    container_name: tplexity-parser
    ports:
      - "8011:8011"
    volumes:
      - parser_data:/app/data
      - parser_sessions:/app
    env_file:
      - src/tplexity/parser/.env
    environment:
      - WEBHOOK_URL=http://retriever:8010/v1/retriever/documents
      - LLM_CLIENT_API_URL=http://llm_client:8014
      - DATA_DIR=/app/data
    depends_on:
      retriever:
        condition: service_healthy
      llm_client:
        condition: service_healthy
    networks:
      - tplexity-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  tplexity-network:
    driver: bridge

volumes:
  parser_data:
    driver: local
  parser_sessions:
    driver: local
  redis_data:
    driver: local
  qdrant_data:
    driver: local

